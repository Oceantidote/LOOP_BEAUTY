<div class="product-details-container">
  <div class="product-details">
    <div class="product-image-container d-none d-md-flex">
      <div class="product-carousel">
        <div class="product-shade-image">
          <%= image_tag url_for(@product.shades.first.card_photo.variant(resize: '700x700')), onclick: "myFunction(this);", class: "item-image-thumbnail", alt: "shade photo"  %>
        </div>
        <% @product.shades.first.photos.first(3).each do |shade_photo| %>
          <div class="product-shade-image">
            <%= image_tag url_for(shade_photo.variant(resize: '700x700')), onclick: "myFunction(this);", class: "item-image-thumbnail", alt: "shade photo"  %>
          </div>
        <% end %>
      </div>
      <div class="product-main-image">
        <div class="myImg" id="expandedImg" style="background-image: url(<%= url_for(@product.shades.first.card_photo.variant(resize: '700x700')) %>); background-position: center; background-size: cover;">
        </div>
        <%#= image_tag url_for(@product.shades.first.card_photo), id: "expandedImg", class: "myImg magniflier", alt: "shade photo" %>
      </div>
    </div>
    <div class="product-info-container assistant">
    <%= simple_form_for(([@product, BasketProduct.new(product: @product)]), remote: :true) do |f| %>
      <%= f.input :shade_id, as: :hidden, input_html: { value: @product.shades.order(created_at: :ASC)[0].id } %>
      <p class="mb-1 bold ls-sm"><%= @product.brand.name.upcase %></p>
      <h3 class="lighter neue-machina large-text ls-sm mb-3"><%= @product.title %></h3>
      <div class="card_ratings mb-3 mb-md-5">
        <%= render 'shared/ratings', rating: @product.average_rating.to_i %>
        <p id="product-show-reviews" class="small-text ml-1 lighter"><%= @product.total_reviews %> <%= 'review'.pluralize(@product.total_reviews) %></p>
      </div>
      <div class="d-block d-md-none">
        <%= render 'show_carousel', photos: @product.shades.first.photos.first(3) %>
      </div>
      <div class="d-flex justify-content-between my-4">
        <h3 class="product-price mb-0 large-text neue-machina"><%= humanized_money_with_symbol(@product.price) %></h3>
      </div>
      <hr class="mt-3 mb-4 mb-md-3">
      <p class="product-shade-title small-margin-bottom ls-xs"><%= @product.shades.order(created_at: :ASC).first.name %></p>
      <% if @product.shades.count > 1 %>
        <div class="shades-container">
          <div class="row" style="margin: 0; width: 100%;">
            <% @product.shades.order(created_at: :ASC).each_with_index do |shade, i| %>
              <% next unless shade.shade_color.attached? %>
              <div class="col-2" style="padding: 0 4px 0 0;">
                <div class="product-shade-card shade_<%= shade.id %> <%= 'product-shade-card-selected' if i == 0 %>" data-shadeId="<%= shade.id %>" style="background-image: url(<%= url_for(shade.shade_color.variant(resize: '90x90')) %>)",
                  data-name="<%= shade.name %>",
                  data-stock="<%= shade.number_in_stock %>"
                  data-main="<%= url_for(shade.card_photo.variant(resize: '700x700')) %>"
                  data-urls="<%= shade.photos.first(3).map { |photo| url_for(photo.variant(resize: '700x700')) } %>">
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
      <div class="mb-5">
        <div class="button-holder">
          <% if @product.out_of_stock? %>
            <%= f.submit 'OUT OF STOCK', disabled: true, class: "primary-button disabled-button w-100 ls-xs" %>
          <% elsif @product.shades.order(created_at: :ASC).first.out_of_stock? %>
            <%= f.submit 'OUT OF STOCK', disabled: true, class: "primary-button disabled-button w-100 ls-xs" %>
          <% else %>
            <%= f.submit 'ADD TO BAG', id: "add-to-bag", class: "primary-button w-100 ls-xs" %>
          <% end %>
        </div>
        <% if user_signed_in? && current_user.wishlist %>
          <div id="item-<%= @product.id %>-wishlist" class="product-show-wishlist">
            <%= render 'shared/product_show_wishlist', product: @product %>
          </div>
        <% end %>
      </div>
    <% end %>
      <div class="product-details-section info-expand">
        <div class="product-details-title">
          <h6 class="neue-machina ls-xs">Product Details</h6>
          <i class="fas fa-plus pd-expand"></i>
        </div>
        <p class="product-details-text neue-machina small-text ls-xs"><%= @product.details %></p>
      </div>
      <div class="benefits-section info-expand">
        <div class="benefits-title">
          <h6 class="neue-machina ls-xs">Benefits</h6>
          <i class="fas fa-plus be-expand"></i>
        </div>
        <div class="benefits-text">
          <% @product.benefits.each do |benefit| %>
            <p class="neue-machina no-margin small-text ls-xs">- <%= benefit.name %></p>
          <% end %>
        </div>
      </div>
      <div class="about-the-brand-section info-expand">
        <div class="about-the-brand-title">
          <h6 class="neue-machina ls-xs">About the Brand</h6>
          <i class="fas fa-plus ab-expand"></i>
        </div>
        <p class="about-the-brand-text neue-machina small-text ls-xs"><%= @product.brand.description %></p>
      </div>
      <div class="share-section">
        <h6 class="neue-machina ls-xs">Share</h6>
        <div class="articles-link-icons">
          <%= link_to "http://www.facebook.com/sharer/sharer.php?u=#{product_url(@product)}&t=#{@product.title}", target: "_blank", class: 'no-decoration' do %>
            <div class="footer-social-link mr-2 product-share-icons">
              <i class="fab fa-facebook-f"></i>
            </div>
          <% end %>
          <%= link_to "https://twitter.com/intent/tweet?text=#{@product.title}&url=#{product_url(@product)}", target: "_blank", class: 'no-decoration' do %>
            <div class="footer-social-link product-share-icons">
              <i class="fab fa-twitter"></i>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
<% if current_user&.admin %>
  <div class="admin-options">
    <div class="container">
      <hr>
      <h6 class="boldest">Admin options</h6>
      <%= link_to 'EDIT PRODUCT', edit_admin_product_path(@product), class: 'secondary-button' %>
      <hr>
    </div>
  </div>
<% end %>

<!-- INSIDER REVIEWS -->

<div class="content-margin position-relative insider-reviews-container">
  <div class="content-container content-carousel">
    <h2 class="neue-machina ls-sm mb-5 text-center">Net Approved</h2>
    <div class="d-block d-md-none">
      <div id="mobileInsiderReviewsCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
        <div class="carousel-inner">
          <% @product.insider_reviews.each_with_index do |review, index| %>
            <div class="carousel-item <%= 'active' if index == 0 %>">
              <div class="row m-0">
                <% if @product.insider_reviews.count == 0 %>
                  <p class="text-center medium-margin width-100 kaftan grey boldest small-text">There are no insider reviews yet</p>
                <% end %>
                <%= render 'insider_review_card', review: review %>
              </div>
            </div>
          <% end %>
        </div>
        <a class="carousel-control-prev" href="#mobileInsiderReviewsCarousel" role="button" data-slide="prev">
          <%= image_tag 'right_caret.png', width: 40 %>
        </a>
        <a class="carousel-control-next" href="#mobileInsiderReviewsCarousel" role="button" data-slide="next">
          <%= image_tag 'right_caret.png', width: 40 %>
        </a>
      </div>
    </div>

    <div class="d-none d-md-block">
      <div id="insiderReviewsCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
        <div class="carousel-inner">
          <% @product.insider_reviews.each_slice(2) do |reviews| %>
            <div class="carousel-item <%= 'active' if reviews[0] == @product.insider_reviews.first %>">
              <div class="row m-0">
                <% if @product.insider_reviews.count == 0 %>
                  <p class="text-center medium-margin width-100 kaftan grey boldest small-text">There are no insider reviews yet</p>
                <% end %>
                <% reviews.each do |review| %>
                  <%= render 'insider_review_card', review: review %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
        <% if @product.insider_reviews.count > 2 %>
          <a class="carousel-control-prev" href="#insiderReviewsCarousel" role="button" data-slide="prev">
            <%= image_tag 'right_caret.png', width: 40 %>
          </a>
          <a class="carousel-control-next" href="#insiderReviewsCarousel" role="button" data-slide="next">
            <%= image_tag 'right_caret.png', width: 40 %>
          </a>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- TUTORIALS -->
<% if @tutorials.any? %>
  <div class="content-margin">
    <div class="content-container position-relative">
      <h2 class="neue-machina ls-sm mb-5 text-center">Watch Our Experts Use The Product</h2>
      <div class="row row-products">
        <% @tutorials.each do |tutorial| %>
          <div class="col-12 col-md-6">
            <div class="card-image-results homepage-products mb-5">
              <div class="card">
                <%= link_to tutorial_path(tutorial) do %>
                  <div class="button-overlay d-none d-md-flex">
                    <div class="oval-button mx-3">
                      <div class="button-text">
                        <p class="mb-0 bt-5 ls-sm">Play Video</p>
                      </div>
                      <%= image_tag 'oval-button.svg' %>
                    </div>
                  </div>
                  <div class="card_image">
                    <%= image_tag url_for(tutorial.cover_photo.variant(resize: '300x300')), alt: "product shade photo" %>
                  </div>
                <% end %>
                <%= image_tag 'play-button.png', class: 'play-button' %>
              </div>
              <div class="card-info">
                <p class="mb-2 truncate-text lighter ls-xs"><%= tutorial.title %></p>
                <p class="neue-machina text-secondary"><%= tutorial.user.instagram %></p>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="content-margin last-content-margin">
  <div class="content-container position-relative">
    <h2 class="neue-machina ls-sm mb-5 text-center">Similar Products Our Customers Love</h2>
    <div class="row m-0">
      <% @products.each do |product| %>
        <div class="col-12 col-sm-6 col-md-4 p-2 p-lg-3">
          <div class="product-cards-holder">
            <%= render 'shared/product_cards', product: product %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- <%# if @product.sent_recommended_products.any? %>
  <div class="recommended-products-wrapper">
    <div class="recommended-products-header">
      <h2 class="insider-info-title text-center">Recommended Products</h2>
    </div>
    <div class="max-width">
      <div class="row-carousel">
        <%#= image_tag 'small-back.png', class: 'carousel-buttons cb-left' %>
        <%# @product.sent_recommended_products.each do |product| %>
          <div class="col-8 col-sm-6 col-md-3 d-flex justify-content-center tp-cols" >
            <div class="card-image-results">
              <div class="card">
                <%#= link_to product_path(product.recommended) do %>
                  <div class="card_image">
                    <%# if product.recommended.shades.first&.card_photo %>
                      <%#= image_tag url_for(product.recommended.shades.first.card_photo.variant(resize: '700x700')), alt: "product shade photo" %>
                    <%# else %>
                      <div style="background-color: #EFEFEF; min-height: 131.5px; max-height: 204px; height: 13rem; width: 100%"></div>
                    <%# end %>
                  </div>
                <%# end %>
                <div class="card_header">
                  <p class="kaftan boldest"><%#= product.recommended.title %></p>
                </div>
                <div class="card_price-heart kaftan boldest">
                  <%#= humanized_money_with_symbol(product.recommended.price) %>
                </div>
                <div class="my-products-purchase">
                  <%#= link_to 'Add to bag', my_product_product_path(product.recommended), remote: true, method: :post, class: "my-products-button" %>
                </div>
              </div>
            </div>
          </div>
        <%# end %>
        <%#= image_tag 'small-forward.png', class: 'carousel-buttons cb-right' %>
      </div>
    </div>
  </div>
<%# end %> -->

<% if @product.customer_reviews.any? %>
  <div class="content-margin last-content-margin mt-0">
    <div class="content-container position-relative customer-reviews">
      <h2 class="neue-machina ls-sm mb-5 text-center">What People Are Saying</h2>
      <div class="row m-0">
        <div class="col-12 p-0 px-md-3">
          <div class="row m-0 mb-4">
            <div class="customer-reviews-left m-0 mr-md-5">
              <div class="customer-reviews-grid-section">
                <h6 class="neue-machina medium-text mb-0"><span class="semi-bold main-rating"><%= @product.average_rating %></span> out of 5 stars</h6>
                <%= render 'shared/ratings', rating: @product.average_rating.to_i %>
                <% if current_user&.ordered_products&.include?(@product) && (current_user.influencer ? !@product.insider_reviews.any?{|review| review.user == current_user} : !@product.customer_reviews.any?{|review| review.user == current_user}) %>
                  <%= link_to 'WRITE A REVIEW', '#', class: "primary-button w-100 mt-4", data: { toggle: 'modal', target: '#customerReviewsModal' } %>
                <% else %>
                  <%= link_to 'WRITE A REVIEW', '#', class: "primary-button w-100 mt-4 disable-click" %>
                <% end %>
              </div>
            </div>
            <div class="d-none d-md-block">
              <div class="rating-breakdown">
                <h2 class="medium-text text-center mb-3"><%= @product.total_reviews %> <%= 'review'.pluralize(@product.total_reviews) %></h2>
                <div class="d-flex align-items-center justify-content-start mb-2">
                  <%= image_tag 'checked-star.png', class: 'ratings-star mr-1', alt: "Rating stars" %>
                  <h6 class="normal mb-0 mr-2">5</h6>
                  <div class="ratings-bar" style="">
                    <div class="filled-ratings-bar" style="width: <%= @rated_five %>%">
                    </div>
                  </div>
                  <h6 class="small-text normal mb-0 ml-1"> <%= @product.customer_reviews.where(rating: 5).size %> </h6>
                </div>
                <div class="d-flex align-items-center justify-content-start mb-2">
                  <%= image_tag 'checked-star.png', class: 'ratings-star mr-1', alt: "Rating stars" %>
                  <h6 class="normal mb-0 mr-2">4</h6>
                  <div class="ratings-bar" style="">
                    <div class="filled-ratings-bar" style="width: <%= @rated_four %>%">
                    </div>
                  </div>
                  <h6 class="small-text normal mb-0 ml-1"> <%= @product.customer_reviews.where(rating: 4).size %> </h6>
                </div>
                <div class="d-flex align-items-center justify-content-start mb-2">
                  <%= image_tag 'checked-star.png', class: 'ratings-star mr-1', alt: "Rating stars" %>
                  <h6 class="normal mb-0 mr-2">3</h6>
                  <div class="ratings-bar" style="">
                    <div class="filled-ratings-bar" style="width: <%= @rated_three %>%">
                    </div>
                  </div>
                  <h6 class="small-text normal mb-0 ml-1"> <%= @product.customer_reviews.where(rating: 3).size %> </h6>
                </div>
                <div class="d-flex align-items-center justify-content-start mb-2">
                  <%= image_tag 'checked-star.png', class: 'ratings-star mr-1', alt: "Rating stars" %>
                  <h6 class="normal mb-0 mr-2">2</h6>
                  <div class="ratings-bar" style="">
                    <div class="filled-ratings-bar" style="width: <%= @rated_two %>%">
                    </div>
                  </div>
                  <h6 class="small-text normal mb-0 ml-1"> <%= @product.customer_reviews.where(rating: 2).size %> </h6>
                </div>
                <div class="d-flex align-items-center justify-content-start mb-2">
                  <%= image_tag 'checked-star.png', class: 'ratings-star mr-1', alt: "Rating stars" %>
                  <h6 class="normal mb-0 mr-2">1</h6>
                  <div class="ratings-bar" style="">
                    <div class="filled-ratings-bar" style="width: <%= @rated_one %>%">
                    </div>
                  </div>
                  <h6 class="small-text normal mb-0 ml-1"> <%= @product.customer_reviews.where(rating: 1).size %> </h6>
                </div>
              </div>
            </div>
          </div>
          <div class="" id="reviews-target">
            <%= render 'customer_review_card', customer_reviews: @customer_reviews %>
          </div>
          <div class="customer-review-pagination-container mt-3">
            <div class="col-12 d-flex justify-content-center">
              <p class="ls-xs mb-0" id="info-target"><%= page_entries_info @customer_reviews %></p>
            </div>
            <div class="col-12 d-flex justify-content-center" id="paginate-target">
              <%= paginate @customer_reviews, remote: true %>
            </div>
          </div>
          <% if current_user&.admin %>
            <div class="admin-options">
              <div class="container">
                <hr>
                <h6 class="boldest">Admin options</h6>
                <%= link_to 'EDIT CUSTOMER REVIEWS', admin_product_customer_reviews_path(@product), class: 'secondary-button' %>
                <hr>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<% if current_user&.ordered_products&.include?(@product) && (current_user.influencer ? !@product.insider_reviews.any?{|review| review.user == current_user} : !@product.customer_reviews.any?{|review| review.user == current_user}) %>
  <div class="modal fade" id="customerReviewsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered customer-review-modal" role="document">
      <div class="modal-content">
        <div class="product-review-wrapper">
          <%= simple_form_for [@product, current_user.influencer ? InsiderReview.new : CustomerReview.new] do |f| %>
              <h4 class="neue-machina text-center mb-5">Tell Us About Your Experience?</h4>
              <% unless current_user.influencer %>
                <div class="customer-review-input mb-5">
                  <%= f.input :title, label: false, placeholder: "Review Title", input_html: { class: 'product-show-review-input pl-0' } %>
                </div>
              <% end %>
              <div class="customer-review-input mb-5">
                <%= f.input :review, label: false, placeholder: "Describe Your Product Experience", input_html: { class: 'product-show-review-input pl-0' } %>
              </div>
              <div class="customer-review-input mb-5">
                <p class="s-medium-text mb-2 ls-xs">How Would You Rate The Product?</p>
                <%= f.input :rating, collection: [1,2,3,4,5], label: false, input_html: { class: 'dropdown-input sign-up-dropdown', id: 'review_rating' } %>
              </div>
              <% unless current_user.influencer %>
                <div class="customer-review-input mb-5">
                  <%= f.input :recommendation, collection: ['Yes', 'No', 'Maybe'], label: false, prompt: 'Would you recommend this product?', input_html: { class: 'dropdown-input sign-up-dropdown pl-0' } %>
                </div>
              <% end %>
              <%= f.submit 'LEAVE A REVIEW' , class: 'primary-button s-medium-text mx-auto my-0' %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>

  numOfReviews = document.getElementById('product-show-reviews');
  reviewsContainer = document.getElementById('product-show-reviews-container');
  numOfReviews.addEventListener('click', function() {
    reviewsContainer.scrollIntoView({behavior: "smooth", block: "start", inline: "nearest"});
  })

  function myFunction(imgs) {
  // Get the expanded image
  expandImg = document.getElementById("expandedImg");
  // Get the image text
  imgText = document.getElementById("imgtext");
  // Use the same src in the expanded image as the image being clicked on from the grid
  expandImg.style.backgroundImage = `url(${imgs.src})`;
  // Use the value of the alt attribute of the clickable image as text inside the expanded image
  // imgText.innerHTML = imgs.alt;
  // Show the container element (hidden with CSS)
  // expandImg.parentElement.style.display = "block";
  }

  details = document.querySelector(".product-details-title");
  detailsText = document.querySelector(".product-details-text");
  aboutBrand = document.querySelector(".about-the-brand-title");
  aboutBrandText = document.querySelector(".about-the-brand-text");
  benefit = document.querySelector(".benefits-title");
  benefitsText = document.querySelector(".benefits-text");
  expandIconProduct = document.querySelector(".pd-expand");
  expandIconBenefit = document.querySelector(".be-expand");
  expandIconBrand = document.querySelector(".ab-expand");
  addToBag = document.getElementById('add-to-bag');
  itemAdded = document.querySelector('.item-added');
  basketIcon = document.querySelector('.basket-icon-container');
  basketIconMobile = document.querySelector('.basket-icon-mobile')
  recommendedItemAdded = document.querySelectorAll('.my-products-button')

  details.addEventListener('click', function() {
    expandIconProduct.classList.toggle('fa-plus');
    expandIconProduct.classList.toggle('fa-minus');
    // detailsText.classList.toggle('show-text');
    $(detailsText).slideToggle();
  });

  if (<%= @product.benefits.any? %>) {
    benefit.addEventListener('click', function() {
      expandIconBenefit.classList.toggle('fa-plus');
      expandIconBenefit.classList.toggle('fa-minus');
      // benefitsText.classList.toggle('show-text');
      $(benefitsText).slideToggle();
    });
  }

    aboutBrand.addEventListener('click', function() {
      expandIconBrand.classList.toggle('fa-plus');
      expandIconBrand.classList.toggle('fa-minus');
      // aboutBrandText.classList.toggle('show-text');
      $(aboutBrandText).slideToggle();
    });

  if (addToBag) {
    addToBag.addEventListener('click', function() {
      addToBag.value = 'ITEM ADDED';
      itemAdded.classList.add('item-added-show');
      basketIcon.style.animation = 'basket-bounce 2s ease'
      basketIconMobile.style.animation = 'basket-bounce 2s ease'
      setTimeout(() => basketIcon.style.animation = '', 2000)
      setTimeout(() => basketIconMobile.style.animation = '', 2000)
      setTimeout(() => itemAdded.classList.remove('item-added-show'), 4000)
      setTimeout(() => addToBag.disabled = true, 100)
      setTimeout(() => addToBag.disabled = false, 4000)
      setTimeout(() => addToBag.value = 'ADD TO BAG', 3500)
    });
  }

  recommendedItemAdded.forEach((addedItem) => {
    addedItem.addEventListener('click', function() {
      addedItem.innerHTML = 'Item added';
      console.log(addedItem.value)
      itemAdded.classList.add('item-added-show');
      basketIcon.style.animation = 'basket-bounce 2s ease'
      basketIconMobile.style.animation = 'basket-bounce 2s ease'
      setTimeout(() => basketIcon.style.animation = '', 2000)
      setTimeout(() => basketIconMobile.style.animation = '', 2000)
      setTimeout(() => itemAdded.classList.remove('item-added-show'), 4000)
      setTimeout(() => addedItem.disabled = true, 100)
      setTimeout(() => addedItem.disabled = false, 4000)
      setTimeout(() => addedItem.innerHTML = 'Add to bag', 3500)
    });
  })

  function playVideo(tutorial_id) {
    videoOverlay = document.querySelector(`.video-overlay_${tutorial_id}`);
    video = document.getElementById(`tutorial-show-video_${tutorial_id}`);
    modal = document.getElementById(`tutorial-modal_${tutorial_id}`);
    videoOverlay.style.display = "none";
    video.play();
    video.controls = 'true';
    modal.addEventListener('click', (event) => {
      if (modal.classList.contains('show') == false) {
        videoOverlay.style.display = "block";
        video.pause()
      }
    })
  }

</script>
